<?php
namespace common;
use app\models\exam\Createpaper;
use app\models\exam\Examprocess;
use app\models\question\Problem;
use app\models\question\Questions;
use app\models\question\Solution;
use app\models\question\SourceCode;
use app\models\question\SourceCodeUser;
use app\models\question\Testcase;
use app\models\system\TbcuitmoonDictionary;
use app\models\teachplan\Examplan;
use yii\data\Pagination;

use yii\helpers\Url;

class commonFuc{


    /**
     * 生成32位guid唯一标识
     * 所有id都用这个生成
     * @return string
     */
    function create_id() {
        $charid = strtoupper(md5(uniqid(mt_rand(), true)));
        $hyphen = chr(45);
        $uuid =
            substr($charid, 0, 8)
            .substr($charid, 8, 4)
            .substr($charid,12, 4)
            .substr($charid,16, 4)
            .substr($charid,20,12)
        ;
        return $uuid;
    }

    /**
     * 操作成功
     * 返回常规msg Josn格式
     * @param $msg 需要返回的信息
     */
    function JsonSuccess($msg){
        $msg = array('error' => 0,'msg' => $msg);
        echo json_encode($msg);
    }

    /**
     * @param $msg
     * 失败时返回
     */
    function JsonFail($msg){
        $msg = array('error' => 2,'msg' => $msg);
        echo json_encode($msg);
    }



    /**
     * 获取客户端IP
     * @return string 返回ip地址,如127.0.0.1
     */
    function getClientIp()
    {
        $onlineip = 'Unknown';
        if (isset($_SERVER['HTTP_X_FORWARDED_FOR']))
        {
            $ips = explode(",", $_SERVER['HTTP_X_FORWARDED_FOR']);
            $real_ip = $ips['0'];
            if ($_SERVER['HTTP_X_FORWARDED_FOR'] && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $real_ip))
            {
                $onlineip = $real_ip;
            }
            elseif ($_SERVER['HTTP_CLIENT_IP'] && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['HTTP_CLIENT_IP']))
            {
                $onlineip = $_SERVER['HTTP_CLIENT_IP'];
            }
        }
        if ($onlineip == 'Unknown' && isset($_SERVER['HTTP_CDN_SRC_IP']) && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['HTTP_CDN_SRC_IP']))
        {
            $onlineip = $_SERVER['HTTP_CDN_SRC_IP'];
            $c_agentip = 0;
        }
        if ($onlineip == 'Unknown' && isset($_SERVER['HTTP_NS_IP']) && preg_match ( '/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER ['HTTP_NS_IP'] ))
        {
            $onlineip = $_SERVER ['HTTP_NS_IP'];
            $c_agentip = 0;
        }
        if ($onlineip == 'Unknown' && isset($_SERVER['REMOTE_ADDR']) && preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/', $_SERVER['REMOTE_ADDR']))
        {
            $onlineip = $_SERVER['REMOTE_ADDR'];
            $c_agentip = 0;
        }
        return $onlineip;
    }


    /**
     * 将字典中的code转换为名字
     * @param $code
     * @return mixed
     */
    public function codeTranName($code){
        $m_dic = new TbcuitmoonDictionary();
        $value = $m_dic->find()->select('CuitMoon_DictionaryName')->where([
            'CuitMoon_DictionaryCode' => $code,
        ])->asArray()->one();
        return $value['CuitMoon_DictionaryName'];
    }


    /**
     * @param $name
     * @return mixed
     */
    public function nameTranCode($name){
        $m_dic = new TbcuitmoonDictionary();
        $value = $m_dic->find()->select('CuitMoon_DictionaryCode')->where([
            'CuitMoon_DictionaryName' => $name,
        ])->asArray()->one();
        return $value['CuitMoon_DictionaryCode'];
    }


    /**
     * 分页插件
     * 参数为一个model对象
     * 返回分页对象,具体查看Yii分页插件
     * @param $model
     * @return Pagination
     */
    public function Tab($model){
        $pages = new Pagination([
            'totalCount' => $model->count(),
            'pageSize' => '15',
            'pageParam' => 'page',
            'pageSizeParam' => 'per-page',

        ]);
        return $pages;
    }


    /*
   * 写入测试用例
   */
    // $ProblemId, 'test.in', $value->TestCaseInput, $path
    function mkData($pid,$filename,$input,$OJ_DATA){

        $basedir = "$OJ_DATA/$pid";

        if(!file_exists($basedir)) {
            mkdir($basedir);
        }

        $fp = @fopen ( $basedir . "/$filename", "w" );
        if($fp){
            fputs ( $fp, preg_replace ( "(\r\n)", "\n", $input ) );
            fclose ( $fp );
        }else{
            echo "Error while opening".$basedir . "/$filename ,try [chgrp -R www-data $OJ_DATA] and [chmod -R 771 $OJ_DATA ] ";

        }
    }


    /**
     * @param $ID       题号
     * @param $Code     代码
     * @param $Time     等待时间 一般为10s
     * @return int|string
     * 在线编译 返回百分比格式
     */
    function Compile($ID,$Code,$Time)
    {
        $m_test_case = new Testcase();
        $m_question = new Questions();
        //查找当前编译的题目
        $Question = $m_question->findOne([
            'QuestionBh' => $ID
        ]);
        //查找所有测试用例
        $TestCase = $m_test_case->find()->select(['TestCaseBh','ScoreWeight','TestCaseInput','TestCaseOutput','Memo'])
            ->where(['QuestionId' => $ID])->all();
        $Problems = [];
        if ($Question->ProblemID == null) {
            //遍历测试用例
            foreach ($TestCase as $value) {
                //新建一个problem
                $m_problem = new Problem();
                $m_problem->title = $ID;
                $m_problem->in_date = date("Y-m-d H:i:s");
                $m_problem->time_limit = 1;
                $m_problem->memory_limit = 128;
                $m_problem->defunct = 'N';
                $m_problem->save();
                //获取对应的problem id
                $ProblemId = $m_problem->attributes['problem_id'];
                

                $path =  "/home/judge/data";
//                $path = __DIR__ . '/../../../Question_TestCase';
                $this->mkData($ProblemId, 'test.in', $value->TestCaseInput, $path);
                $this->mkData($ProblemId, 'test.out', $value->TestCaseOutput, $path);
                $x = shell_exec("cp ".$_SERVER['DOCUMENT_ROOT']."/QuestionFile/".$ID."/* /home/judge/data/".$ProblemId);
                // $value->Memo = (string)$ProblemId;
                $value->save();

                $Problems[$ProblemId] = $value->ScoreWeight;
            }

            $Question->ProblemID = 0;
            $Question->update();

        } else {
            foreach ($TestCase as $value) {
                $Problems[$value->Memo] = $value->ScoreWeight;
            }
        }

        if (count($Problems) > 0) {
            foreach ($Problems as $key=>$item) {
                $m_solution = new Solution();
                $m_source = new SourceCode();
                $m_source_user = new SourceCodeUser();

                $m_solution->problem_id = $key;
                $m_solution->user_id = 'admin';
                $m_solution->in_date = date("Y-m-d H:i:s");
                $m_solution->language = 0;
                $m_solution->code_length = strlen($Code);
                $m_solution->ip = $this->getClientIp();
                $m_solution->save();
                $SolutionID = $m_solution->attributes['solution_id'];

                $Solutions[$SolutionID] = $item;

                $m_source->solution_id = $SolutionID;
                $m_source->source = $Code;
                $m_source_user->solution_id = $SolutionID;
                $m_source_user->source = $Code;

                $m_source->save();
                $m_source_user->save();
            }
        }



        sleep($Time);
        $Score = 0;
        foreach ($Solutions as $key=>$item) {
//                sleep(1);
            $Result = $m_solution->findOne(['solution_id'=> $key]);
//            sleep(1);
            switch ($Result->result) {
                case 4:
                    $Score = $Score + $item;
                    break;
                case 11:
                    return json_encode('编译失败');
                    exit();
                    // die;
                    break;
                default:
                    $Score = $Score + 0;
                    break;
            }
        }
        echo $Score;
    }

    public function Compilex($ID,$Code,$Time)
    {
        $m_test_case = new Testcase();
        $m_question = new Questions();
        //查找当前编译的题目
        $Question = $m_question->findOne([
            'QuestionBh' => $ID
        ]);
        //查找所有测试用例
        $TestCase = $m_test_case->find()->select(['TestCaseBh','ScoreWeight','TestCaseInput','TestCaseOutput','Memo'])
            ->where(['QuestionId' => $ID])->all();
        $Problems = [];
        if ($Question->ProblemID == null) {
            //遍历测试用例
            foreach ($TestCase as $value) {
                //新建一个problem
                $m_problem = new Problem();
                $m_problem->title = $ID;
                $m_problem->in_date = date("Y-m-d H:i:s");
                $m_problem->time_limit = 1;
                $m_problem->memory_limit = 128;
                $m_problem->defunct = 'N';

                
                $m_problem->save();
                //获取对应的problem id
                $ProblemId = $m_problem->attributes['problem_id'];
                

                $path =  "/home/judge/data";
//                $path = __DIR__ . '/../../../Question_TestCase';
                $this->mkData($ProblemId, 'test.in', $value->TestCaseInput, $path);
                $this->mkData($ProblemId, 'test.out', $value->TestCaseOutput, $path);
                $x = shell_exec("cp ".$_SERVER['DOCUMENT_ROOT']."/QuestionFile/".$ID."/* /home/judge/data/".$ProblemId);

                // var_dump($x);
                // $value->Memo = (string)$ProblemId;
                $value->save();

                $Problems[$ProblemId] = $value->ScoreWeight;
            }

            $Question->ProblemID = 0;
            $Question->update();

        } else {
            foreach ($TestCase as $value) {
                $Problems[$value->Memo] = $value->ScoreWeight;
            }
        }

        if (count($Problems) > 0) {
            foreach ($Problems as $key=>$item) {
                $m_solution = new Solution();
                $m_source = new SourceCode();
                $m_source_user = new SourceCodeUser();

                $m_solution->problem_id = $key;
                $m_solution->user_id = 'admin';
                $m_solution->in_date = date("Y-m-d H:i:s");
                $m_solution->language = 0;
                $m_solution->code_length = strlen($Code);
                $m_solution->ip = $this->getClientIp();
                $m_solution->save();
                $SolutionID = $m_solution->attributes['solution_id'];

                $Solutions[$SolutionID] = $item;

                $m_source->solution_id = $SolutionID;
                $m_source->source = $Code;
                $m_source_user->solution_id = $SolutionID;
                $m_source_user->source = $Code;

                $m_source->save();
                $m_source_user->save();
            }
        }



        sleep($Time);
        $Score = 0;
        foreach ($Solutions as $key=>$item) {
//                sleep(1);
            $Result = $m_solution->findOne(['solution_id'=> $key]);
//            sleep(1);
            switch ($Result->result) {
                case 4:
                    $Score = $Score + $item;
                    break;
                case 11:
                    return json_encode('编译失败');
                    exit();
                    // die;
                    break;
                default:
                    $Score = $Score + 0;
                    break;
            }
        }
        return $Score;
    }
    /**
     * @param $PaperBh
     * @return mixed
     */
    function GetPaper($PaperBh)
    {
        $m_create_paper = new Createpaper();
        $Data = [];
        $QuestionTypes = $m_create_paper->find()->select(['Memo'])
            ->where([
                'PaperBh' => $PaperBh,
            ])->groupBy(['Memo'])->asArray()->all();//查找试卷所有类型
        foreach ($QuestionTypes as $item) {
            $Tmp = $m_create_paper->find()->where([
                'PaperBh' => $PaperBh,
                'Memo' => $item['Memo'],
            ])->all();
            foreach ($Tmp as $value) {
                $TmpData = $value->question;
                $TmpData['Score'] = $value->TotalScore;
                $Tmp_Data[] = $TmpData;
            }
            $Data[$item['Memo']] = $Tmp_Data;
            unset($Tmp_Data);
        }

        return $Data;

    }


    /**
     * @param $Data
     * @param $ExamPlanBh
     * function Save Paper Answer
     */
    function SavePaper($Data,$ExamPlanBh)
    {
        foreach ($Data as $key=>$item) {
            $m_exam_process = new Examprocess();
            $m_question = new Questions();

            $Tmp = $m_exam_process->findOne([
                'PaperID' => $ExamPlanBh,
                'QuestionBh' => $key,
            ]);
            $QuestionType = Questions::find()->where([
                'QuestionBh' => $key,
            ])->asArray()->one()['QuestionType'];
            switch ($QuestionType) {
                case 100020102:
                    $item = implode("|",$item);
                    break;
                case 1000204:
                case 1000208:
                    $Tmp_Data = null;
                    foreach ($item as $value) {
                        $Tmp_Data = $Tmp_Data.$value.'@';
                    }
                    $item = $Tmp_Data;
                    break;
                default:
                    break;
            }

            if ($Tmp) {
                $Tmp->PaperID = $ExamPlanBh;
                $Tmp->QuestionBh = $key;
                $Tmp->Answer = $item;
                $Tmp->SubmitTime = date('Y-m-d H:i:s');
                $Tmp->Memo = (string)$QuestionType;
                $Tmp->update();
            }else{
                $m_exam_process->PaperID = $ExamPlanBh;
                $m_exam_process->QuestionBh = $key;
                $m_exam_process->Answer = $item;
                $m_exam_process->Memo = (string)$QuestionType;
                $m_exam_process->SubmitTime = date('Y-m-d H:i:s');
                $m_exam_process->save();
            }
        }
    }

}